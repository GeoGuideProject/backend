<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GeoHighlight - Data Analysis</title>


  <meta http-equiv="cache-control" content="max-age=0" />
  <meta http-equiv="cache-control" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
  <meta http-equiv="pragma" content="no-cache" />

  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <link href="/static/bootstrap.min.css" rel="stylesheet">
  <link href="/static/style_index.css" rel="stylesheet">
  <script src="/static/leaflet.js"></script>
  <script src="/static/d3.v3.min.js"></script>
  <script src="/static/leaflet-heat.js"></script>
  <html manifest="/static/app.appcache">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      font-family: 'Roboto', sans-serif;
      font-size: 12px;
    }

    .sidebar {
      position: absolute;
      margin: 0;
      top:0;
      left:0;
      /*background: rgba(125, 125, 125, 0.40);*/
      height: 100%;
      /*opacity: 0.75;*/
      z-index: 1000;
      padding: 1em;
      width: 20em;
      pointer-events: none;
    }

    .sidebar .control {
      pointer-events: auto;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.3);
    }

    .sidebar .control h3 {
      margin-top: 0;
      font-size: 1.3em;
      font-weight: 500;
    }

    .mapContainer {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    #map {
      height: 100%;
      width: 100%;
      margin: 0;
    }

    #heatMapUI {
  	  background-color: #fff;
  	  border: 2px solid #fff;
  	  border-radius: 3px;
  	  box-shadow: 0 2px 6px rgba(0,0,0,.3);
  	  cursor: pointer;
  		margin-right: 10px;
  	  text-align: center;
  	}

  	#heatMapText {
  	  color: rgb(25,25,25);
  	  font-family: Roboto, Arial, sans-serif;
  	  font-size: 15px;
  	  line-height: 25px;
  	  padding-left: 5px;
  	  padding-right: 5px;
  		pointer-events: auto;
  	}
  </style>
</head>
<body>
  <!-- <nav class="navbar navbar-inverse">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="">GeoHighlight</a>
      </div>
    </div>
  </nav> -->


  <!-- <div class="container">
    <div class="page-header">
      <h1 class="text-center">Select the &sigma; and the K similar points</h1>
      <h2 class="text-center"><small>To show on map.</small></h2>
    </div>
  </div> -->

  <div class="sidebar">
    <div class="row">
      <div class="col-md-12">
        <div class="control well  well-sm range-group">
          <h3>Similarity Range</h3>
          <div class="form-group select-range">
            <label for="range">Range Limits:</label>
            <select id="range" name="range" class="form-control">
              <option value="0">0.0 ~ 0.1</option>
              <option value="1">0.1 ~ 0.2</option>
              <option value="2">0.2 ~ 0.3</option>
              <option value="3">0.3 ~ 0.4</option>
              <option value="4">0.4 ~ 0.5</option>
              <option value="5">0.5 ~ 0.6</option>
              <option value="6">0.6 ~ 0.7</option>
              <option value="7">0.7 ~ 0.8</option>
              <option value="8">0.8 ~ 0.9</option>
              <option value="9">0.9 ~ 1.0</option>
            </select>
            <input type="button" class="btn btn-default show-button" onClick="refreshMap()" value="Show/Reset">
          </div>
        </div>
      </div>
      <div class="col-md-12">
        <div class="control well  well-sm timelimit-group">
          <h3>Highlighter Definition</h3>
          <div class="form-group">
            <label for="timelimit">Time Limit(ms):</label>
            <input type="number" id="timelimit" name="timelimit" value="100" min="100" max="20000" required class="form-control">
          </div>
          <div class="form-group">
            <label for="sigma">&sigma;:</label>
            <input type="number" id="sigma" name="sigma" value="1.00" min="0.00" max="1.00" step="0.01" required class="form-control">
          </div>
          <div class="form-group">
            <label for="kvalue">K:</label>
            <input type="number" id="kvalue" name="kvalue" value="1" min="1" max="50" required class="form-control">
          </div>
        </div>
      </div>
    </div>
    <div class="row" hidden>
      <div class="container-fluid">
        <h3>Point Information:</h3>
        <input type="text" name="pointInfo" id="pointInfo">
        <input type="button" class="btn btn-success show-button" onClick="runPass(1)" value="First Pass">
        <input type="button" id="seccondpass" class="btn btn-success show-button" onClick="runPass(2)" value="Seccond Pass" disabled>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div class="control well well-sm divanalysis" id="firstAnalysis">
          <h3>Analysis</h3>
          <label for="basic-url">Selected:</label>
          <p id="firstSelected"></p>
          <label for="basic-url">Similarity:</label>
          <p id="firstSimilarity"></p>
          <label for="basic-url">Top K similar point:</label>
          <p id="firstKPoints"></p>
        </div>
      </div>
      <div class="col-md-6" hidden>
        <div class="well  well-sm divanalysis" id="seccondAnalysis">
          <h3>Seccond analysis</h3>
          <label for="basic-url">Selected:</label>
          <p id="seccondSelected"></p>
          <label for="basic-url">Similarity:</label>
          <p id="seccondSimilarity"></p>
          <label for="basic-url">Top K similar point:</label>
          <p id="seccondKPoints"></p>
        </div>
      </div>
    </div>
  </div>

  <div class="mapContainer">
    <div id="map"></div>
  </div>
  <script>
    var pointChose, firstPoint, firstArrayPoints, map;
    var markers = [];
    var infowindows = [];
    var infowindowsOpened = null;

    var iconBlue = '/static/images/marker-icon.png';
    var iconGreen = '/static/images/marker-icon-green.png';
    var iconRed = '/static/images/marker-icon-red.png';
    var iconYellow = '/static/images/marker-icon-yellow.png';
    var runningRequest = false;

    var heatMap,
        heatMapPoints = [],
        isHeatMap = false;

    document.getElementById("pointInfo").value = "";
    // ----------------------------------------------------------
    // ------------------------- Create the map and locate center
    // ----------------------------------------------------------

    function HeatMapControl(controlDiv, map) {

      var control = this;

      controlDiv.style.clear = 'both';

      var heatMapUI = document.createElement('div');
      heatMapUI.id = 'heatMapUI';
      controlDiv.appendChild(heatMapUI);

      var heatMapText = document.createElement('div');
      heatMapText.id = 'heatMapText';
      heatMapText.innerHTML = 'Heat';
      heatMapUI.appendChild(heatMapText);

      heatMapUI.addEventListener('click', function() {
        heatMapPoints = markers.map(function(marker) {
          marker.setVisible(isHeatMap);
          return marker.position;
        });

        isHeatMap = !isHeatMap;

        if (isHeatMap) {
          heatmap.setData(heatMapPoints);
          heatmap.setMap(map);
          heatMapText.innerHTML = 'Normal';
        }
        else {
          heatmap.setMap(null);
          heatMapText.innerHTML = 'Heat';
        }
        if (infowindowsOpened != null) {
          infowindowsOpened.close();
        }
      });
    }

    function initMap() {
      // Create a map object and specify the DOM element for display.
      var mapType = new google.maps.StyledMapType([{
        featureType: "all",
        elementType: "all",
        stylers: [{ saturation: -100 }]
      }], { name: "Grayscale" });

      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 9,
        mapTypeControlOptions: {
            mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.HYBRID, google.maps.MapTypeId.SATELLITE, google.maps.MapTypeId.TERRAIN, 'grayscale'],
            position: google.maps.ControlPosition.TOP_RIGHT,
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
        },
        streetViewControl: false
      });

      map.mapTypes.set('grayscale', mapType);
      map.setMapTypeId('grayscale');

      heatmap = new google.maps.visualization.HeatmapLayer({
  			data: heatMapPoints,
  			radius: 50,
  			map: map,
  		});

      var heatMapDiv = document.createElement('div');
  	  var heatMap = new HeatMapControl(heatMapDiv, map);

  	  heatMapDiv.index = 1;
  		heatMapDiv.style['padding-top'] = '10px';
  	  heatMapDiv.style['pointer-events'] = 'none';
  	  map.controls[google.maps.ControlPosition.RIGHT_TOP].push(heatMapDiv);

      d3.csv("/dataanalysis/index.csv", function(error, data) {
        var latmed = parseFloat(d3.min(data, function(d) { return d.latitude; })) + parseFloat(d3.max(data, function(d) { return d.latitude; }));
        var latmed = latmed/2;
        var longmed = parseFloat(d3.min(data, function(d) { return d.longitude; })) + parseFloat(d3.max(data, function(d) { return d.longitude; }));
        var longmed = longmed/2;
        map.setCenter({lat: latmed, lng: longmed});
      });
    }

    function clearMap(){
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
      markers = [];
      infowindows = [];
    }

    function addPoint(platitude, plongitude, picon, pindex, options){
      var contentString = '<div><h4>Profile</h4>';

      for (key in options) {
        if (options[key] === undefined) { continue; }
        var value = options[key];
        if (Number(options[key])) {
          var number = Number(options[key]);
          value = Number.isInteger(number) ? number.toString() : parseFloat(Number(options[key]).toFixed(5)).toString();
        }
        contentString += '<b>' + key + '</b>: ' + value + '<br />';
      }
      contentString += '<button type="button" class="btn btn-primary show-button" onClick="runPass(1)">Show</button>';
      contentString += '</div>';

      var infowindow = new google.maps.InfoWindow({
        content: contentString
      });

      var marker = new google.maps.Marker({
        position: new google.maps.LatLng(platitude, plongitude),
        map: map,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 7,
          fillColor: picon === iconYellow ? '#F44336' : '#2196F3',
          fillOpacity: 0.75,
          strokeWeight: 0
        },
        pointId: pindex,
        latitude: platitude,
        longitude: plongitude,
      });

      marker.addListener('click', function() {
        if (infowindowsOpened != null) {
          infowindowsOpened.close();
        }
        infowindow.open(map, marker);
        infowindowsOpened = infowindow;
      })

      infowindows.push(infowindow);
      markers.push(marker);
      return marker;
    }

    function refreshMap(){
      var arrayPoints = [];
      document.getElementById("seccondpass").disabled = true;
      document.getElementById("pointInfo").value = "";
      document.getElementById("firstAnalysis").style.display = "none";
      document.getElementById("seccondAnalysis").style.display = "none";
      clearMap();
      var namefile = "/dataanalysis/dspoints/" + document.getElementById("range").options[document.getElementById("range").selectedIndex].value + "_" +(parseInt(document.getElementById("range").options[document.getElementById("range").selectedIndex].value)+1) + ".csv";
      d3.csv(namefile, function(error, dsPointsLines) {
        var auxArrayPoints = [];
        dsPointsLines.forEach(function(dsLine) {
          auxArrayPoints.push(dsLine.p1);
          auxArrayPoints.push(dsLine.p2);
        });
        //Remove point equals
        arrayPoints = auxArrayPoints.filter(function(item, pos) {
          return auxArrayPoints.indexOf(item) == pos;
        });
        d3.csv("/dataanalysis/index.csv", function(error, indexLines) {
          var stop = 0;
          indexLines.forEach(function(indexLine) {
            arrayPoints.forEach(function(point) {
              if(indexLine.p_index == point){
                addPoint(indexLine.latitude, indexLine.longitude, iconBlue, indexLine.p_index, indexLine).addListener('click', onPointClick);
              }
            });
          });
          if (isHeatMap) {
    				isHeatMap = !isHeatMap;
    				document.getElementById('heatMapUI').click();
    			}
        });
      });
      function onPointClick(event) {
        document.getElementById("pointInfo").value = "ID: " + this.pointId + " - Latitude: " + this.latitude + " - Longitude: " + this.longitude;
        pointChose = this.pointId;
      }
    }

    function showFirstRequestOnMap(){
      clearMap();
      d3.csv("/dataanalysis/index.csv", function(error, indexLines) {
        var stop = 0;
        indexLines.forEach(function(indexLine) {
          firstArrayPoints.array.forEach(function(point) {
            if(indexLine.p_index == point){
              addPoint(indexLine.latitude, indexLine.longitude, iconYellow, indexLine.p_index, indexLine).addListener('click', onPointClick);
            }
          });
          if(indexLine.p_index == firstPoint){
            addPoint(indexLine.latitude, indexLine.longitude, iconBlue, indexLine.p_index, indexLine).addListener('click', onPointClick);
            document.getElementById("firstAnalysis").style.display = "block";
            document.getElementById("seccondAnalysis").style.display = "none";
            document.getElementById("firstSelected").innerHTML = firstPoint;
            document.getElementById("firstKPoints").innerHTML = firstArrayPoints.array.join(', ');
            document.getElementById("firstSimilarity").innerHTML = firstArrayPoints.similarity;
          }
        });
        if (isHeatMap) {
  				isHeatMap = !isHeatMap;
  				document.getElementById('heatMapUI').click();
  			}
      });
      function onPointClick(event) {
        document.getElementById("pointInfo").value = "ID: " + this.pointId + " - Latitude: " + this.latitude + " - Longitude: " + this.longitude;
        pointChose = this.pointId;
        if(pointChose != firstPoint) {
          document.getElementById("seccondpass").disabled = false;
        }
        else{
          document.getElementById("seccondpass").disabled = true;
        }
      }
    }

    function showSeccondRequestOnMap(jsonResponse){
      clearMap();
      d3.csv("/dataanalysis/index.csv", function(error, indexLines) {
        var stop = 0;
        indexLines.forEach(function(indexLine) {
          firstArrayPoints.array.forEach(function(point) {
            if(indexLine.p_index == point){
              addPoint(indexLine.latitude, indexLine.longitude, iconYellow, indexLine.p_index, indexLine).addListener('click', onPointClick);
            }
          });
          if(indexLine.p_index == firstPoint){
            addPoint(indexLine.latitude, indexLine.longitude, iconBlue, indexLine.p_index, indexLine).addListener('click', onPointClick);
          }
          jsonResponse.array.forEach(function(point) {
            if(indexLine.p_index == point){
              addPoint(indexLine.latitude, indexLine.longitude, iconRed, indexLine.p_index, indexLine).addListener('click', onPointClick);
            }
          });
          if(indexLine.p_index == pointChose){
            addPoint(indexLine.latitude, indexLine.longitude, iconGreen, indexLine.p_index, indexLine).addListener('click', onPointClick);
            document.getElementById("seccondAnalysis").style.display = "block";
            document.getElementById("seccondSelected").innerHTML = pointChose;
            document.getElementById("seccondKPoints").innerHTML = jsonResponse.array;
            document.getElementById("seccondSimilarity").innerHTML = jsonResponse.similarity;
          }
        });
      });
      function onPointClick(event) {
        document.getElementById("pointInfo").value = "ID: " + this.pointId + " - Latitude: " + this.latitude + " - Longitude: " + this.longitude;
        pointChose = this.pointId;
        var disableSeccondPass = false;
        firstArrayPoints.array.forEach(function(point) {
          if(point == pointChose){
           disableSeccondPass = true;
         }
       });
        if(pointChose == firstPoint){
          disableSeccondPass = true;
        }
        document.getElementById("seccondpass").disabled = disableSeccondPass;
      }
    }

    function runPass(pass){
      if(document.getElementById("pointInfo").value == ""){
        alert("Any point selected!")
      }
      else{
        if(runningRequest == false){
          runningRequest == true;
          var loader = new XMLHttpRequest();
          loader.onreadystatechange = function ()
          {
            if(this.status == 200 && this.readyState == XMLHttpRequest.DONE){
              var jsonResponse = JSON.parse(this.responseText);
              document.getElementById("pointInfo").value = "";
              if(pass == 1){
                firstPoint = pointChose;
                firstArrayPoints = jsonResponse;
                document.getElementById("seccondpass").disabled = true;
                showFirstRequestOnMap();
              }
              else if(pass == 2){
                showSeccondRequestOnMap(jsonResponse);
              }
              runningRequest == false;
            }
          }
          strSend = '/runiuga?timelimit=' + document.getElementById("timelimit").value + '&pointchose=' + pointChose + '&sigma=' + document.getElementById("sigma").value + '&kvalue=' + document.getElementById("kvalue").value;
          loader.open('GET', strSend, true);
          loader.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          loader.send();
        }
        else{
          alert("Wait finish before run again!");
        }
      }
    }

    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkb8SUi3_g9PJxJgGfydzLqmqIp3NpUeU&&libraries=visualization&callback=initMap"></script>
</body>
</html>
